{% extends "data_visualization/base.html" %} 
{% load static %} 
{% block content %}
<div id="map"></div>
<button class="layer-button-box" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasLayer" aria-controls="offcanvasLayer">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-layers-fill" viewBox="0 0 16 16">
        <path d="M7.765 1.559a.5.5 0 0 1 .47 0l7.5 4a.5.5 0 0 1 0 .882l-7.5 4a.5.5 0 0 1-.47 0l-7.5-4a.5.5 0 0 1 0-.882z" />
        <path d="m2.125 8.567-1.86.992a.5.5 0 0 0 0 .882l7.5 4a.5.5 0 0 0 .47 0l7.5-4a.5.5 0 0 0 0-.882l-1.86-.992-5.17 2.756a1.5 1.5 0 0 1-1.41 0z" />
    </svg>
</button>

<!-- Box hiển thị thông tin điểm quan trắc -->
<div class="data-info-table d-none">
    <div class="data-info-table__nav">
        <p id="data-info-table__title">Thông tin Trạm quan trắc</p>
        <button id="data-info-table__close-btn" type="button" class="btn close-offcanvas-layer-btn">
            <span>Đóng</span>
        </button>
    </div>

    <table class="table table-bordered table-striped">
        <tbody>
            <tr>
                <td>Key</td>
                <td>Value</td>
            </tr>
        </tbody>
    </table>

    <!-- Dữ liệu mực nước -->
    <div class="collapse-header" data-bs-toggle="collapse" data-bs-target="#water-level-collapse" aria-expanded="false" aria-controls="water-level-collapse">
        <div class="data-info-table__nav">
            <p id="data-info-table__title">Dữ liệu Mực nước</p>
        </div>
        <span class="icon" id="water-level-toggle-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="000" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.854a.5.5 0 0 1 .708 0L8 10.5l5.646-5.646a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
            </svg>
        </span>
    </div>
    <div class="collapse multi-collapse" id="water-level-collapse">
        <div class="chart-controll">
            <div>
                <label>Từ ngày</label>
                <input class="start-date" type="date" name="" id="">
            </div>
            <div>
                <label>Đến ngày</label>
                <input class="end-date" type="date" name="" id="">
            </div>
            <button class="btn view-data-button" id="view-water-level-button">Xem</button>
        </div>

        <div class="loading-box d-none">
            <div class="spinner-border text-info" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <button class="btn cancel-button">Hủy</button>
        </div>

        <p class="error-text d-none">Có lỗi xảy ra, vui lòng thử lại!</p>
        
        <canvas id="water-level-chart" class="d-none"></canvas>
    </div>
    
    <!-- Dữ liệu nhiệt độ -->
    <div class="collapse-header" data-bs-toggle="collapse" data-bs-target="#water-temp-collapse" aria-expanded="false" aria-controls="water-temp-collapse">
        <div class="data-info-table__nav">
            <p id="data-info-table__title">Dữ liệu Nhiệt độ</p>
        </div>
        <span class="icon" id="water-temp-toggle-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="000" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.854a.5.5 0 0 1 .708 0L8 10.5l5.646-5.646a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
            </svg>
        </span>
    </div>
    
    <div class="collapse multi-collapse" id="water-temp-collapse">
        <div class="chart-controll">
            <div>
                <label>Từ ngày</label>
                <input class="start-date" type="date" name="" id="">
            </div>
            <div>
                <label>Đến ngày</label>
                <input class="end-date" type="date" name="" id="">
            </div>
            <button class="btn view-data-button" id="view-water-temp-button">Xem</button>
        </div>
        
        <div class="loading-box d-none">
            <div class="spinner-border text-info" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <button class="btn cancel-button">Hủy</button>
        </div>
        
        <p class="error-text d-none">Có lỗi xảy ra, vui lòng thử lại!</p>
        
        <canvas id="water-temp-chart" class="d-none"></canvas>
    </div>

    <!-- Dữ liệu hóa học -->
    <!-- <div class="collapse-header" data-bs-toggle="collapse" data-bs-target="#water-chemistry-collapse" aria-expanded="false"
        aria-controls="water-chemistry-collapse">
        <div class="data-info-table__nav">
            <p id="data-info-table__title">Dữ liệu Hóa học</p>
        </div>
        <span class="icon" id="water-chemistry-toggle-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="000" class="bi bi-chevron-down"
                viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                    d="M1.646 4.854a.5.5 0 0 1 .708 0L8 10.5l5.646-5.646a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
            </svg>
        </span>
    </div>
    
    <div class="collapse multi-collapse" id="water-chemistry-collapse">
        <div class="chart-controll">
            <div>
                <label>Từ ngày</label>
                <input class="start-date" type="date" name="" id="">
            </div>
            <div>
                <label>Đến ngày</label>
                <input class="end-date" type="date" name="" id="">
            </div>
            <button class="btn view-data-button" id="view-water-chemistry-button">Xem</button>
        </div>
        <div class="chart-controll">
            <div>
                <label>Thông số</label>
                <select id="parameter-chemistry" class="parameter">
                    <option value="1">---Chọn thông số---</option>
                </select>
            </div>
        </div>
    
        <div class="loading-box d-none">
            <div class="spinner-border text-info" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <button class="btn cancel-button">Hủy</button>
        </div>
    
        <p class="error-text d-none">Có lỗi xảy ra, vui lòng thử lại!</p>
    
        <canvas id="water-chemistry-chart" class="d-none"></canvas>
    </div> -->
</div>

<!-- Offcanvas chọn layer -->
<div class="offcanvas offcanvas-start" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvasLayer" aria-labelledby="offcanvasLayerLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasLayerLabel">Lớp bản đồ</h5>
        <button type="button" class="btn close-offcanvas-layer-btn" data-bs-dismiss="offcanvas" aria-label="Đóng">
            <span>Thu nhỏ</span>
        </button>
    </div>
    <div class="offcanvas-body">
        <!-- Hiển thị các thành phần bản đồ -->
        <!-- Lớp mạng lưới trạm quan trắc -->
        <div class="collapse-header" data-bs-toggle="collapse" data-bs-target="#network-layer-collapse" aria-expanded="false" aria-controls="network-layer-collapse">
            <div class="d-flex" style="align-items: center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-layers-fill" viewBox="0 0 16 16">
                    <path d="M7.765 1.559a.5.5 0 0 1 .47 0l7.5 4a.5.5 0 0 1 0 .882l-7.5 4a.5.5 0 0 1-.47 0l-7.5-4a.5.5 0 0 1 0-.882z" />
                    <path d="m2.125 8.567-1.86.992a.5.5 0 0 0 0 .882l7.5 4a.5.5 0 0 0 .47 0l7.5-4a.5.5 0 0 0 0-.882l-1.86-.992-5.17 2.756a1.5 1.5 0 0 1-1.41 0z" />
                </svg>
                <h6 style="margin-left: 8px;">Mạng lưới cơ sở y tế</h6>
            </div>
            <span class="icon" id="network-layer-toggle-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="000" class="bi bi-chevron-down"
                    viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M1.646 4.854a.5.5 0 0 1 .708 0L8 10.5l5.646-5.646a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
                </svg>
            </span>
        </div>
        <div class="collapse multi-collapse" id="network-layer-collapse">
            <div class="network-layers layer-items">
                <div class="layer-item">
                    <div class="form-check form-switch" style="margin-bottom: 10px;">
                        <input class="form-check-input" type="checkbox" role="switch" id="switch-01" />
                        <label class="form-check-label" for="switch-01">Bệnh viện</label>
                    </div>
                    
                </div>
            </div>
            <div class="network-layers layer-items">
                <div class="layer-item">
                    <div class="form-check form-switch" style="margin-bottom: 10px;">
                        <input class="form-check-input" type="checkbox" role="switch" id="switch-02" />
                        <label class="form-check-label" for="switch-01">Trạm y tế / phòng khám</label>
                    </div>
            
                </div>
            </div>
            <div class="network-layers layer-items">
                <div class="layer-item">
                    <div class="form-check form-switch" style="margin-bottom: 10px;">
                        <input class="form-check-input" type="checkbox" role="switch" id="switch-03" />
                        <label class="form-check-label" for="switch-01">Nha khoa</label>
                    </div>
            
                </div>
            </div>
            <div class="network-layers layer-items">
                <div class="layer-item">
                    <div class="form-check form-switch" style="margin-bottom: 10px;">
                        <input class="form-check-input" type="checkbox" role="switch" id="switch-04" />
                        <label class="form-check-label" for="switch-01">Nhà thuốc</label>
                    </div>
            
                </div>
            </div>
            
        </div>
        <hr>
        <!-- Chuyên đề dự báo cảnh báo -->
        <div class="collapse-header" data-bs-toggle="collapse" data-bs-target="#forecast-layer-collapse" aria-expanded="false"
            aria-controls="forecast-layer-collapse">
            <div class="d-flex" style="align-items: center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-layers-fill" viewBox="0 0 16 16">
                    <path d="M7.765 1.559a.5.5 0 0 1 .47 0l7.5 4a.5.5 0 0 1 0 .882l-7.5 4a.5.5 0 0 1-.47 0l-7.5-4a.5.5 0 0 1 0-.882z" />
                    <path d="m2.125 8.567-1.86.992a.5.5 0 0 0 0 .882l7.5 4a.5.5 0 0 0 .47 0l7.5-4a.5.5 0 0 0 0-.882l-1.86-.992-5.17 2.756a1.5 1.5 0 0 1-1.41 0z" />
                </svg>
                <h6 style="margin-left: 8px;">Chuyên đề dự báo cảnh báo</h6>
            </div>
            <span class="icon" id="forecast-layer-toggle-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="000" class="bi bi-chevron-down"
                    viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M1.646 4.854a.5.5 0 0 1 .708 0L8 10.5l5.646-5.646a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
                </svg>
            </span>
        </div>
        <div class="collapse multi-collapse" id="forecast-layer-collapse">
            <div class="forecast-layers layer-items" style="padding-right:0px ;">
                <!-- Dự báo mực nước tháng 10 -->
                <div class="collapse-header" data-bs-toggle="collapse" data-bs-target="#water-10-collapse" aria-expanded="false"
                    aria-controls="water-10-collapse">
                    <h6>Dự báo mực nước tháng 10/2024</h6>
                    <span class="icon" id="water-10-toggle-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="000" class="bi bi-chevron-down"
                            viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M1.646 4.854a.5.5 0 0 1 .708 0L8 10.5l5.646-5.646a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
                        </svg>
                    </span>
                </div>
                <div class="collapse multi-collapse" id="water-10-collapse">
                    <div class="water-10-layers layer-items">
                        <div class="layer-item form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="switch-population"/>
                            <label class="form-check-label" for="switch-population">Mật độ dân số</label>
                        </div>
                        <div class="layer-item form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="switch-road-layer" />
                            <label class="form-check-label" for="switch-road-layer">Mạng lưới giao thông đường bộ</label>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <!-- Lớp bản đồ nền -->
        <div class="collapse-header" data-bs-toggle="collapse" data-bs-target="#bg-layer-collapse" aria-expanded="false" aria-controls="bg-layer-collapse">
            <h6>Bản đồ nền</h6>
            <span class="icon" id="bg-layer-toggle-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="000" class="bi bi-chevron-down"
                    viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M1.646 4.854a.5.5 0 0 1 .708 0L8 10.5l5.646-5.646a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
                </svg>
            </span>
        </div>
        <div class="collapse multi-collapse" id="bg-layer-collapse">
            <div class="background-layers layer-items" > 
                <div class="layer-item active" bg-layer-name="becagis">
                    <div class="layer-image"></div>
                    <p class="layer-name">Mặc định</p>
                </div>
        
                <div class="layer-item" bg-layer-name="streets">
                    <div class="layer-image"></div>
                    <p class="layer-name">Đường phố</p>
                </div>
        
                <div class="layer-item" bg-layer-name="satellite">
                    <div class="layer-image"></div>
                    <p class="layer-name">Vệ tinh</p>
                </div>
        
                <div class="layer-item" bg-layer-name="topo">
                    <div class="layer-image"></div>
                    <p class="layer-name">Địa hình</p>
                </div>
        
                <div class="layer-item" bg-layer-name="openstreetmap">
                    <div class="layer-image"></div>
                    <p class="layer-name">Open Street Map</p>
                </div>
            </div>
        </div>
    </div>
    <div class="offcanvas-footer" style="text-align: center;">
        <!-- <img src="{% static 'data_visualization/images/logo.png' %}" width="32" height="32" /> -->
        <p style="font-size: 12px; margin-top: 4px;">© Copyright 2024 MKDC ICT</p>
    </div>
</div>

<div class="legend-box">
    <div class="legend-scrollable">
            <!-- Mực nước T10 - tầng q3-->
            <div class="d-none" id="water-4">
                <p class="mt-2"><i>Mực nước T10 - Tầng q3</i></p>
                <div class="layer-legend__item">
                    <div class="tag-triangle-up" style="border-bottom-color: #00ff40;border-top:0px"></div>
                    <span class="legend-text">Dâng từ 1.0 đến < 2.0</span>
                </div>
                <div class="layer-legend__item">
                    <div class="tag-triangle-up large_triangle" style="border-bottom-color: #00ff40;border-top:0px"></div>
                    <span class="legend-text">Dâng từ 0.5 đến < 1.0</span>
                </div>
                <div class="layer-legend__item">
                    <div class="tag-triangle-up medium_triangle" style="border-bottom-color: #00ff40;border-top:0px"></div>
                    <span class="legend-text">Dâng từ 0.2 đến < 0.5</span>
                </div>
                <div class="layer-legend__item">
                    <div class="tag-triangle-up small_triangle" style="border-bottom-color: #00ff40;border-top:0px"></div>
                    <span class="legend-text">Dâng từ 0.05 đến < 0.2</span>
                </div>
                <div class="layer-legend__item">
                    <div class="tag-square" style="background-color: #00ff40; width:10px; height:10px; margin-left:1px"></div>
                    <span class="legend-text">Dâng hạ không đáng kể</span>
                </div>
                <div class="layer-legend__item">
                    <div class="tag-triangle-down medium_triangle" style="border-bottom:0px"></div>
                    <span class="legend-text">Hạ từ 0.05 đến < 0.2</span>
                </div>
                <div class="layer-legend__item large_triangle">
                    <div class="tag-triangle-down" style="border-top-color: #ff0000;border-bottom:0px"></div>
                    <span class="legend-text">Hạ từ 0.2 đến < 0.5</span>
                </div>
                <div class="layer-legend__item">
                    <div class="tag-triangle-down" style="border-top-color: #ff0000; border-bottom:0px"></div>
                    <span class="legend-text">Hạ từ 1.0 đến < 2.0</span>
                </div>
            </div>
        <!-- <div class="layer-legend__item" id="item_13">
            <div class="image-container">
                <img src="https://gis.mkdc.com.vn/geoserver/data_visualization/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&LAYER=data_visualization:qp3_MucNuoc_T9vsT8&legend_options=fontName:Times%20New%20Roman;fontAntiAliasing:true;fontColor:0x000033;fontSize:12"
                    alt="Legend Graphic" class="bottom-only">
            </div>
        </div> -->
    </div>
</div>

{% endblock %}

{% block styles %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'data_visualization/vendors/maplibre-gl@4.3.1/maplibre-gl.css' %}" />
<link href="{% static 'data_visualization/css/pages/home.css' %}" rel="stylesheet" />
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="{% static 'data_visualization/vendors/chartjs@3.0.0/chart.min.js' %}" type="text/javascript"></script>
<script src="{% static 'data_visualization/vendors/maplibre-gl@4.3.1/maplibre-gl.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>

<!-- Script xử lý sự kiện đóng mở collapse -->
<script>
    const geojsonPath = "{% static 'data_visualization/data/ms.geojson' %}";

    $(document).ready(function() {
        // Lắng nghe sự kiện khi Offcanvas mở
        $('#offcanvasLayer').on('show.bs.offcanvas', function () {
            $('.legend-box').removeClass('fixed-div-close');
            $('.legend-box').addClass('fixed-div-open');
        });

        // Lắng nghe sự kiện khi Offcanvas đóng
        $('#offcanvasLayer').on('hide.bs.offcanvas', function () {
            $('.legend-box').removeClass('fixed-div-open');
            $('.legend-box').addClass('fixed-div-close');
        });
    });

    var svg_chevron_up = 
    `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="000" class="bi bi-chevron-up" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M1.646 11.146a.5.5 0 0 0 .708 0L8 5.5l5.646 5.646a.5.5 0 0 0 .708-.708l-6-6a.5.5 0 0 0-.708 0l-6 6a.5.5 0 0 0 0 .708z"/>
        </svg>
    `;

    var svg_chevron_down = 
    `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="000" class="bi bi-chevron-down" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M1.646 4.854a.5.5 0 0 1 .708 0L8 10.5l5.646-5.646a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
        </svg>
    `;

    $(document).ready(function () {
        // Hàm đóng mở collapse
        function setupCollapseToggle(collapseId, toggleIconId) {
            // Lắng nghe sự kiện mở collapse
            $(collapseId).on("show.bs.collapse", function () {
                $(toggleIconId).html(svg_chevron_up);
            });
             // Lắng nghe sự kiện đóng collapse
            $(collapseId).on("hide.bs.collapse", function () {
                $(toggleIconId).html(svg_chevron_down);
            });
        }

        // Thiết lập cho các layer khác nhau
        setupCollapseToggle("#bg-layer-collapse", "#bg-layer-toggle-icon");
        setupCollapseToggle("#thematic-layer-collapse", "#thematic-layer-toggle-icon");
        setupCollapseToggle("#network-layer-collapse", "#network-layer-toggle-icon");
        setupCollapseToggle("#water-level-collapse", "#water-level-toggle-icon");
        setupCollapseToggle("#water-temp-collapse", "#water-temp-toggle-icon");
        setupCollapseToggle("water_chemistry-collapse", "#water-chemistry-toggle-icon");

        function setupCollapseToggle(collapseId, toggleIconId, useStopPropagation = false) {
            // Lắng nghe sự kiện mở - đóng collapse
            $(collapseId).on("show.bs.collapse", function (e) {
                if (useStopPropagation) e.stopPropagation(); // Ngăn chặn ảnh hưởng đến các phần tử cha.
                $(toggleIconId).html(svg_chevron_up);
            }).on("hide.bs.collapse", function (e) {
                if (useStopPropagation) e.stopPropagation(); // Ngăn chặn ảnh hưởng đến các phần tử cha.
                $(toggleIconId).html(svg_chevron_down);
            });
        }

        // Thiết lập cho các layer khác nhau
        setupCollapseToggle("#forecast-layer-collapse", "#forecast-layer-toggle-icon");
        setupCollapseToggle("#water-8-collapse", "#water-8-toggle-icon", true);
        setupCollapseToggle("#water-9-collapse", "#water-9-toggle-icon", true);
        setupCollapseToggle("#water-10-collapse", "#water-10-toggle-icon", true);


        // Hiển thị legend-2 và layer tương ứng
        function toggleLayer(switchId, layerId) {
        const isChecked = document.querySelector(`#${switchId}`).checked;
        
        map.setLayoutProperty(layerId, "visibility", isChecked ? "visible" : "none");

        const anyChecked = layers.some(layer => document.querySelector(`#${layer.switchId}`).checked);

        const legend = document.querySelector("#legend-04");

        // Hiển thị hoặc ẩn legend dựa trên trạng thái của các lớp
        if (anyChecked) {
            $(legend).removeClass("d-none");
            if (switchId === 'switch-population') {
                if (isChecked) {
                    $("#water-1").removeClass("d-none");
                } else {
                    $("#water-1").addClass("d-none");
                }
            }
        } else {
            // Ẩn toàn bộ legend nếu không có lớp nào được bật
            $(legend).addClass("d-none");
        }
    }

        // Gán sự kiện click cho tất cả các switch
        const layers = [
            { switchId: "switch-population", layerId: "population" },
            { switchId: "switch-road-layer", layerId: "road-layer" },
            { switchId: "switch-01", layerId: "hospitals"},
            { switchId: "switch-02", layerId: "clinics-doctors" },
            { switchId: "switch-04", layerId: "pharmacies" },
            { switchId: "switch-03", layerId: "dentists" },
        ];

        layers.forEach(function(layer) {
            $("#" + layer.switchId).on("click", function() {
                toggleLayer(layer.switchId, layer.layerId);
            });
        });
    });
</script>

<script src="{% static 'data_visualization/js/pages/home.js' %}"></script>

{% endblock %}
